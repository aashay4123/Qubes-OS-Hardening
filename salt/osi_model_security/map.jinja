{# Shared config & sane defaults, pulled from pillar #}
{% set cfg = {
  'strict_crypto':      salt['pillar.get']('osi_model_security:strict_crypto', True),
  'enable_dnsmasq_logs': salt['pillar.get']('osi_model_security:enable_dnsmasq_logs', True),
  'enable_ecs':         salt['pillar.get']('osi_model_security:enable_ecs', False),
  'enable_dnstap':      salt['pillar.get']('osi_model_security:enable_dnstap', False),

  'usb_policy': {
    'storage_allowed_tags': salt['pillar.get']('usb_policy:storage_allowed_tags', ['usb_storage_ok']),
  },

  'dns_tuning': {
    'stats_interval': salt['pillar.get']('dns:stats_interval', 60),
    'rotate_weeks':   salt['pillar.get']('dns:rotate_weeks', 8),
  },

  'transport': {
    'chrony_nts_server':        salt['pillar.get']('transport:chrony_nts_server', 'time.cloudflare.com'),
    'debian_openssl_seclevel':  salt['pillar.get']('transport:debian_openssl_seclevel', 2),
  },

  # Your VM inventories
  'vms':      salt['pillar.get']('osi_model_security:vms', {}),
  'app_vms':  salt['pillar.get']('osi_model_security:app_vms', {}),   {# fixed comma; comment in Jinja style #}

  # Disposables (global defaults + per-VM mappings)
  'disposables': salt['pillar.get']('disposables', {
    'default_dispvm': None,
    'create': {},
    'per_vm_default': {},
    'force_policies': {'openurl_tags': [], 'openinvm_tags': []},
    'fallback': {'openurl': 'ask', 'openinvm': 'ask'}
  }),

  # Optional feature buckets already used by other roles/states
  'undercover_dom0': salt['pillar.get']('undercover_dom0', {}),
  'secrets':         salt['pillar.get']('secrets', {}),
  'opsec':           salt['pillar.get']('opsec', {}),
  'hardening':       salt['pillar.get']('hardening', {}),
  'integrity_alerts':salt['pillar.get']('integrity_alerts', {}),
  'clock_comms':     salt['pillar.get']('clock_comms', {}),
  'sidechannel':     salt['pillar.get']('sidechannel', {}),
  'emergency':       salt['pillar.get']('emergency', {}),
  'boot_firmware':   salt['pillar.get']('boot_firmware', {}),

  # === NEW: healthcheck_user_merge role config (defaults if Pillar not provided) ===
  'healthcheck_user_merge': salt['pillar.get']('healthcheck_user_merge', {
    'expect_templates': {
      'sys-net':      'fedora-42-minimal',
      'sys-firewall': 'fedora-42-minimal',
      'sys-dns':      'fedora-42-minimal',
      'app_default':  'deb_harden',
    },
    'resolver': 'dnscrypt',
    'vpn_vms':  ['sys-vpn','sys-vpn-nl'],
    'vpn_tor_gateway': 'sys-vpn-tor',
    'whonix_ws': ['ws-tor-research','ws-tor-forums'],
    'app_vms':   ['work','dev','personal'],

    'global_default_dispvm': 'debian-12-dvm',
    'per_vm_default_dispvm': {'work':'debian-12-dvm','dev':'debian-12-dvm'},

    'suite_timer': 'disable',  # 'disable' | 'hourly' | 'daily'

    # Deep checks: ON by default (flip to false in Pillar to mute)
    'checks': {
      'dnsmasq':                True,
      'whonix_dns_exclusion':   True,
      'appvm_firewall_drop':    True,
      'ids_suricata':           True,
      'resolver_logs':          True,
      'device_policies':        True,
      'whonix_policy_file':     True,
      'openssl_tls_policy':     True,
      'chrony_nts':             True,
      'ssh_client_hardening':   True,
      'apparmor_browsers':      True,
      'vault_servers':          True,
      'client_wrappers':        True,
      'tags_split_services':    True,
      'updatevm_sys_firewall':  True,
      'dvm_spawn_test':         True,
    }
  }),

  # === Optional: extras role (safe defaults) ===
  'app_leak_guard_extras': salt['pillar.get']('app_leak_guard_extras', {
    'debian_templates': ['deb_harden','deb_harden_min','deb_work','deb_dev'],
    'fedora_templates': ['fedora-42-minimal','fedora-42-vpn'],
    'flags': {
      'disable_screen_portals': True,
      'remove_remote_desktop':  True,
      'remove_flatpak_snap':    True,
      'remove_gnome_oa':        True,
      'null_recent_files':      True,
      'tmpfs_user_cache':       True,
      'disable_clipboard_history': True,
      'ssh_no_forward_agent':   True,
      'git_use_config_only':    True,
      'thunderbird_lockdown':   True,
      'libreoffice_lockdown':   True,
    }
  }),
} %}
{# ---------------- End cfg block ---------------- #}

{# Gather all template names used anywhere for transport hardening, etc. #}
{% set templates = [] %}
{% for _, spec in cfg.vms.items() %}
  {% if spec.get('template') %}{% do templates.append(spec.get('template')) %}{% endif %}
{% endfor %}
{% for _, spec in cfg.app_vms.items() %}
  {% if spec.get('template') %}{% do templates.append(spec.get('template')) %}{% endif %}
{% endfor %}

{# include templates referenced by disposables.create (if any) #}
{% for name, ds in cfg.disposables.get('create', {}).items() %}
  {% if ds.get('template') %}{% do templates.append(ds.get('template')) %}{% endif %}
{% endfor %}

{# Optional: include known role-specific templates if present in pillar #}
{% for t in cfg.app_leak_guard_extras.get('debian_templates', []) %}
  {% do templates.append(t) %}
{% endfor %}
{% for t in cfg.app_leak_guard_extras.get('fedora_templates', []) %}
  {% do templates.append(t) %}
{% endfor %}

{% set templates = templates|unique %}

{# Export helpers many states import #}
{% set all_templates = templates %}
{% set service_vms = cfg.vms.keys()|list %}
{% set app_vm_names = cfg.app_vms.keys()|list %}
